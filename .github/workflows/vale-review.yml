name: Vale + LLM Review

on:
  workflow_call:
    inputs:
      repo:
        description: "The repository to check out"
        required: true
        type: string
      path:
        type: string
        description: "The startPath pointing to the folder containing antora.yml"
        required: false
        default: "."


jobs:
  run-vale:
    runs-on: ubuntu-latest

    steps:
      - name: install vale
        run: |
          sudo snap install vale

      - name: checkout repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          path: content-repo

      - name: fetch runner config
        uses: actions/checkout@v4
        with:
          repository: couchbaselabs/docs-runner
          path: docs-runner

      - name: fetch styles
        uses: actions/checkout@v4
        with:
          repository: couchbaselabs/docs-style-guide
          sparse-checkout: ValeStyles/
          path: docs-style-guide

      - name: debug
        run: |
          sudo snap install tree
          tree -a .

      - name: run vale
        run: |
          vale --config=docs-runner/.vale.ini --minAlertLevel=warning --output=JSON content-repo/$CONTENT_PATH/modules > vale.json
          cat vale.json
          echo "Vale output saved to vale.json"
          echo "OUTPUT=Vale output saved to vale.json" >> $GITHUB_ENV
        env:
          CONTENT_PATH: ${{ inputs.path }}
